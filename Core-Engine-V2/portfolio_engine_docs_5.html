<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portfolio Accounting Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;1,9..144,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0b0e14;
    --surface: #12161f;
    --surface2: #1a1f2e;
    --border: #232a3a;
    --accent: #4fffb0;
    --accent2: #7b8cff;
    --accent3: #ff8c61;
    --text: #d4dbe8;
    --text-muted: #6b7794;
    --text-dim: #3d4866;
    --heading: #eef2ff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-weight: 300;
    line-height: 1.7;
    overflow-x: hidden;
  }

  /* ── NOISE TEXTURE OVERLAY ── */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* ── NAVIGATION ── */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    background: rgba(11,14,20,0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 56px;
  }

  .nav-brand {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    letter-spacing: 0.12em;
    text-transform: uppercase;
  }

  .nav-links {
    display: flex;
    gap: 0;
    list-style: none;
  }

  .nav-links a {
    display: block;
    padding: 0 1rem;
    font-size: 0.78rem;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    text-decoration: none;
    letter-spacing: 0.06em;
    transition: color 0.2s;
    line-height: 56px;
  }

  .nav-links a:hover { color: var(--accent); }

  /* ── HERO ── */
  .hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 8rem 4rem 4rem;
    position: relative;
    overflow: hidden;
  }

  .hero-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.3;
    mask-image: radial-gradient(ellipse 80% 60% at 50% 50%, black, transparent);
  }

  .hero-glow {
    position: absolute;
    width: 600px; height: 600px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(79,255,176,0.06) 0%, transparent 70%);
    top: 50%; left: 50%;
    transform: translate(-50%, -60%);
    pointer-events: none;
  }

  .hero-content { position: relative; max-width: 860px; }

  .hero-eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--accent);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 1.5rem;
    opacity: 0;
    animation: fadeUp 0.6s 0.1s forwards;
  }

  .hero-title {
    font-family: 'Fraunces', serif;
    font-size: clamp(3rem, 7vw, 6rem);
    font-weight: 700;
    color: var(--heading);
    line-height: 1.05;
    margin-bottom: 1.5rem;
    opacity: 0;
    animation: fadeUp 0.7s 0.2s forwards;
  }

  .hero-title em {
    font-style: italic;
    font-weight: 300;
    color: var(--accent);
  }

  .hero-sub {
    font-size: 1.15rem;
    color: var(--text-muted);
    max-width: 560px;
    margin-bottom: 3rem;
    opacity: 0;
    animation: fadeUp 0.7s 0.35s forwards;
  }

  .hero-formula {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 1rem 1.5rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.9rem;
    color: var(--heading);
    border-radius: 4px;
    opacity: 0;
    animation: fadeUp 0.7s 0.5s forwards;
  }

  .hero-formula span { color: var(--accent2); }

  .hero-scroll {
    position: absolute;
    bottom: 2.5rem; left: 4rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    opacity: 0;
    animation: fadeUp 0.6s 0.9s forwards;
  }

  .hero-scroll::before {
    content: '';
    display: block;
    width: 40px; height: 1px;
    background: var(--text-dim);
  }

  /* ── SECTION LAYOUT ── */
  .section {
    padding: 6rem 4rem;
    max-width: 1100px;
    margin: 0 auto;
  }

  .section-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--accent);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
  }

  .section-title {
    font-family: 'Fraunces', serif;
    font-size: clamp(1.8rem, 3.5vw, 2.8rem);
    font-weight: 600;
    color: var(--heading);
    line-height: 1.2;
    margin-bottom: 1.25rem;
  }

  .section-intro {
    font-size: 1.05rem;
    color: var(--text-muted);
    max-width: 640px;
    margin-bottom: 3.5rem;
    line-height: 1.8;
  }

  .divider {
    border: none;
    border-top: 1px solid var(--border);
    margin: 0;
  }

  /* ── COMPONENT CARDS (Architecture) ── */
  .arch-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .arch-card {
    background: var(--surface);
    padding: 2rem;
    transition: background 0.2s;
  }

  .arch-card:hover { background: var(--surface2); }

  .arch-card-num {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    margin-bottom: 0.75rem;
  }

  .arch-card-title {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--heading);
    margin-bottom: 0.5rem;
  }

  .arch-card-tag {
    display: inline-block;
    font-family: 'DM Mono', monospace;
    font-size: 0.62rem;
    padding: 0.2rem 0.6rem;
    border-radius: 3px;
    margin-bottom: 0.75rem;
  }

  .tag-stateful { background: rgba(79,255,176,0.1); color: var(--accent); }
  .tag-stateless { background: rgba(123,140,255,0.1); color: var(--accent2); }
  .tag-orchestrator { background: rgba(255,140,97,0.1); color: var(--accent3); }

  .arch-card p {
    font-size: 0.88rem;
    color: var(--text-muted);
    line-height: 1.65;
  }

  /* ── TWO COLUMN CONTENT ── */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: start;
  }

  @media (max-width: 768px) {
    .two-col { grid-template-columns: 1fr; }
    .hero { padding: 8rem 1.5rem 4rem; }
    .section { padding: 4rem 1.5rem; }
    nav { padding: 0 1rem; }
    .nav-links { display: none; }
  }

  /* ── CASH FLOW TABLE ── */
  .flow-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
  }

  .flow-table tr {
    border-bottom: 1px solid var(--border);
  }

  .flow-table td {
    padding: 0.9rem 1rem;
    vertical-align: top;
  }

  .flow-table td:first-child {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--accent);
    white-space: nowrap;
    width: 100px;
  }

  .flow-table td:last-child {
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    color: var(--text-muted);
  }

  .flow-table tr:hover td { background: var(--surface2); }

  /* ── TAX CARDS ── */
  .tax-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  @media (max-width: 768px) { .tax-grid { grid-template-columns: 1fr; } }

  .tax-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1.75rem;
    position: relative;
    overflow: hidden;
  }

  .tax-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }

  .tax-card.st::before { background: var(--accent3); }
  .tax-card.lt::before { background: var(--accent); }
  .tax-card.div::before { background: var(--accent2); }

  .tax-rate {
    font-family: 'Fraunces', serif;
    font-size: 2.5rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 0.4rem;
  }

  .tax-card.st .tax-rate { color: var(--accent3); }
  .tax-card.lt .tax-rate { color: var(--accent); }
  .tax-card.div .tax-rate { color: var(--accent2); }

  .tax-name {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
  }

  .tax-desc { font-size: 0.85rem; color: var(--text-muted); line-height: 1.6; }

  /* ── FIFO VISUALIZER ── */
  .fifo-demo {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 2rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
  }

  .fifo-title {
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 1.25rem;
  }

  .fifo-lots {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .fifo-lot {
    display: grid;
    grid-template-columns: 70px 1fr auto auto;
    gap: 1rem;
    align-items: center;
    padding: 0.6rem 0.75rem;
    border-radius: 4px;
    border: 1px solid transparent;
    transition: all 0.3s;
  }

  .fifo-lot.sold { background: rgba(79,255,176,0.06); border-color: rgba(79,255,176,0.2); }
  .fifo-lot.partial { background: rgba(255,140,97,0.06); border-color: rgba(255,140,97,0.2); }
  .fifo-lot.untouched { background: var(--surface2); border-color: var(--border); }

  .lot-id { color: var(--text-dim); font-size: 0.72rem; }
  .lot-date { color: var(--text-muted); }
  .lot-shares { color: var(--heading); text-align: right; }
  .lot-tag {
    font-size: 0.62rem;
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    text-align: center;
  }
  .tag-lt { background: rgba(79,255,176,0.15); color: var(--accent); }
  .tag-st { background: rgba(255,140,97,0.15); color: var(--accent3); }
  .tag-open { background: rgba(107,119,148,0.15); color: var(--text-muted); }

  /* ── DIVIDEND STEPS ── */
  .steps {
    display: flex;
    flex-direction: column;
    gap: 0;
    position: relative;
  }

  .steps::before {
    content: '';
    position: absolute;
    left: 19px; top: 20px; bottom: 20px;
    width: 1px;
    background: linear-gradient(to bottom, var(--accent), var(--accent2), transparent);
    opacity: 0.3;
  }

  .step {
    display: flex;
    gap: 1.25rem;
    align-items: flex-start;
    padding: 1.25rem 0;
  }

  .step-num {
    flex-shrink: 0;
    width: 38px; height: 38px;
    border-radius: 50%;
    background: var(--surface2);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--accent);
    position: relative;
    z-index: 1;
  }

  .step-body {}

  .step-title {
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    color: var(--heading);
    font-size: 0.92rem;
    margin-bottom: 0.3rem;
  }

  .step-detail {
    font-family: 'DM Mono', monospace;
    font-size: 0.78rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  /* ── WORKED EXAMPLE ── */
  .example-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .example-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--border);
  }

  .example-col {
    padding: 1.5rem 2rem;
  }

  .example-col:first-child {
    border-right: 1px solid var(--border);
  }

  .example-col-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .example-line {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.35rem 0;
    font-size: 0.82rem;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .example-line:last-child { border-bottom: none; }

  .example-line .label { color: var(--text-muted); }
  .example-line .value { font-family: 'DM Mono', monospace; color: var(--heading); }
  .example-line .value.pos { color: var(--accent); }
  .example-line .value.neg { color: var(--accent3); }

  .example-result {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    border-top: 1px solid var(--border);
  }

  .result-item {
    padding: 1.5rem 2rem;
    border-right: 1px solid var(--border);
  }

  .result-item:last-child { border-right: none; }

  .result-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
  }

  .result-value {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--heading);
  }

  .result-value.accent { color: var(--accent); }
  .result-value.warn { color: var(--accent3); }

  /* ── CONFIG TABLE ── */
  .config-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }

  @media (max-width: 768px) { .config-grid { grid-template-columns: 1fr; } }

  .config-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  .config-block-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border);
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .config-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 1rem;
    align-items: center;
    padding: 0.85rem 1.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    font-size: 0.82rem;
  }

  .config-row:last-child { border-bottom: none; }

  .config-key { font-family: 'DM Mono', monospace; color: var(--accent2); font-size: 0.78rem; }
  .config-default { font-family: 'DM Mono', monospace; color: var(--accent); font-size: 0.8rem; }
  .config-effect { color: var(--text-muted); font-size: 0.78rem; grid-column: 1 / -1; padding-top: 0.1rem; padding-bottom: 0.3rem; }

  /* ── EDGE CASES ── */
  .guardrails {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .guardrail {
    background: var(--surface);
    padding: 1.5rem;
    transition: background 0.2s;
  }

  .guardrail:hover { background: var(--surface2); }

  .guardrail-trigger {
    font-family: 'DM Mono', monospace;
    font-size: 0.73rem;
    color: var(--accent3);
    margin-bottom: 0.5rem;
  }

  .guardrail-response {
    font-size: 0.83rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  .guardrail-response strong { color: var(--accent); font-weight: 500; }

  /* ── REPORTING OUTPUTS ── */
  .outputs-list {
    display: flex;
    flex-direction: column;
    gap: 1px;
    background: var(--border);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .output-item {
    display: grid;
    grid-template-columns: 220px 1fr;
    background: var(--surface);
    transition: background 0.2s;
  }

  .output-item:hover { background: var(--surface2); }

  .output-name {
    padding: 1.25rem 1.5rem;
    border-right: 1px solid var(--border);
    font-family: 'Fraunces', serif;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--heading);
    display: flex;
    align-items: center;
  }

  .output-desc {
    padding: 1.25rem 1.5rem;
    font-size: 0.86rem;
    color: var(--text-muted);
    line-height: 1.65;
    display: flex;
    align-items: center;
  }

  @media (max-width: 768px) {
    .output-item { grid-template-columns: 1fr; }
    .output-name { border-right: none; border-bottom: 1px solid var(--border); padding: 1rem 1.25rem; }
    .example-header, .example-result, .config-grid { grid-template-columns: 1fr; }
    .tax-grid { grid-template-columns: 1fr; }
  }

  /* ── INLINE CODE ── */
  code {
    font-family: 'DM Mono', monospace;
    font-size: 0.82em;
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 0.1em 0.4em;
    border-radius: 3px;
    color: var(--accent2);
  }

  /* ── CODE BLOCK ── */
  .code-block {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1.25rem 1.5rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.7;
    overflow-x: auto;
  }

  .code-block .kw { color: var(--accent2); }
  .code-block .str { color: var(--accent); }
  .code-block .cm { color: var(--text-dim); }
  .code-block .fn { color: var(--accent3); }

  /* ── PRINCIPLE PILLS ── */
  .principles {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .principle {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
    padding: 1.1rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    transition: border-color 0.2s;
  }

  .principle:hover { border-color: var(--accent); }

  .principle-icon {
    flex-shrink: 0;
    width: 28px; height: 28px;
    border-radius: 50%;
    background: rgba(79,255,176,0.1);
    border: 1px solid rgba(79,255,176,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: var(--accent);
    font-family: 'DM Mono', monospace;
    margin-top: 0.1rem;
  }

  .principle-title {
    font-weight: 500;
    color: var(--heading);
    font-size: 0.9rem;
    margin-bottom: 0.2rem;
  }

  .principle-body {
    font-size: 0.83rem;
    color: var(--text-muted);
    line-height: 1.6;
  }

  /* ── FOOTER ── */
  footer {
    border-top: 1px solid var(--border);
    padding: 2.5rem 4rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1100px;
    margin: 0 auto;
  }

  .footer-brand {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    color: var(--text-dim);
    letter-spacing: 0.1em;
  }

  .footer-note {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--text-dim);
  }

  /* ── ANIMATIONS ── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .reveal {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }

  .reveal.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ── SECTION SEPARATOR WITH LABEL ── */
  .sep {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 0 4rem;
    margin: 0 auto;
    max-width: 1100px;
  }

  .sep-line { flex: 1; height: 1px; background: var(--border); }
  .sep-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  /* ── VALUATION FORMULA ── */
  .formula-visual {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
  }

  .formula-visual .big {
    font-family: 'Fraunces', serif;
    font-size: 1.6rem;
    font-weight: 600;
    color: var(--heading);
    line-height: 1.3;
    margin-bottom: 1.5rem;
  }

  .formula-visual .big em { color: var(--accent); font-style: italic; }
  .formula-visual .big span { color: var(--accent2); }

  .formula-breakdown {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 1.5rem;
  }

  .formula-part {
    background: var(--surface2);
    padding: 1rem;
  }

  .formula-part .part-key {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-dim);
    letter-spacing: 0.1em;
    margin-bottom: 0.4rem;
  }

  .formula-part .part-val {
    font-size: 0.82rem;
    color: var(--text-muted);
    line-height: 1.5;
  }

</style>
</head>
<body>

<!-- NAVIGATION -->
<nav>
  <div class="nav-brand">PAE // Docs</div>
  <ul class="nav-links">
    <li><a href="#overview">Overview</a></li>
    <li><a href="#tax">Tax Engine</a></li>
    <li><a href="#fifo">Sell Handling</a></li>
    <li><a href="#dividends">Dividends</a></li>
    <li><a href="#valuation">Valuation</a></li>
    <li><a href="#reporting">Reporting</a></li>
    <li><a href="#config">Config</a></li>
    <li><a href="#allocation">Allocation</a></li>
    <li><a href="#performance">Performance</a></li>
  </ul>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="hero-grid"></div>
  <div class="hero-glow"></div>
  <div class="hero-content">
    <div class="hero-eyebrow">Portfolio Accounting Engine</div>
    <h1 class="hero-title">Built on trades.<br>Not on <em>assumptions.</em></h1>
    <p class="hero-sub">A transaction-driven engine for portfolio valuation, tax handling, and dividend reinvestment. Every dollar is traceable. Every gain is correctly taxed. Every price is real.</p>
    <div class="hero-formula">
      Portfolio Value &nbsp;=&nbsp; <span>(Shares × Price)</span> &nbsp;+&nbsp; Cash
    </div>
  </div>
  <div class="hero-scroll">Scroll to explore</div>
</section>

<!-- SECTION 1: OVERVIEW -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">01 — System Overview</div><div class="sep-line"></div></div>
<section class="section" id="overview">
  <div class="section-label">The Problem</div>
  <h2 class="section-title">Most portfolio models are wrong<br>from the start.</h2>
  <p class="section-intro">Most simulations compound daily returns — multiply yesterday's value by today's price change. It's fast, but it can't answer the question that actually matters: <em>if I liquidated everything right now, what would I walk away with?</em></p>

  <div class="two-col reveal" style="margin-bottom: 3.5rem;">
    <div>
      <div class="section-label" style="margin-bottom: 0.75rem;">What most models do wrong</div>
      <div class="principles">
        <div class="principle" style="border-color: rgba(255,140,97,0.3);">
          <div class="principle-icon" style="background: rgba(255,140,97,0.1); border-color: rgba(255,140,97,0.3); color: var(--accent3);">✕</div>
          <div>
            <div class="principle-title" style="color: var(--accent3);">Inject dividends into return stream</div>
            <div class="principle-body">Blurs price appreciation and cash received. Prevents lot-level tracking of DRIP shares.</div>
          </div>
        </div>
        <div class="principle" style="border-color: rgba(255,140,97,0.3);">
          <div class="principle-icon" style="background: rgba(255,140,97,0.1); border-color: rgba(255,140,97,0.3); color: var(--accent3);">✕</div>
          <div>
            <div class="principle-title" style="color: var(--accent3);">Apply taxes as an end-of-year haircut</div>
            <div class="principle-body">Ignores the timing effect of taxes on reinvestable cash throughout the year.</div>
          </div>
        </div>
        <div class="principle" style="border-color: rgba(255,140,97,0.3);">
          <div class="principle-icon" style="background: rgba(255,140,97,0.1); border-color: rgba(255,140,97,0.3); color: var(--accent3);">✕</div>
          <div>
            <div class="principle-title" style="color: var(--accent3);">Average away transaction costs</div>
            <div class="principle-body">Overstates returns and loses the slippage/commission signal in the cost basis.</div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom: 0.75rem;">What this engine does instead</div>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon">✓</div>
          <div>
            <div class="principle-title">Every dollar traces to a trade</div>
            <div class="principle-body">Nothing happens unless a trade executes. No phantom gains, no drift.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">✓</div>
          <div>
            <div class="principle-title">Taxes deducted from cash immediately</div>
            <div class="principle-body">The portfolio value shown is always the true after-tax number. No adjustment needed.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">✓</div>
          <div>
            <div class="principle-title">Costs baked into cost basis</div>
            <div class="principle-body">Slippage and commission increase the cost basis of each lot, reducing overstated gains.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="section-label" style="margin-bottom: 1rem;">The Five Components</div>
  <div class="arch-grid reveal">
    <div class="arch-card">
      <div class="arch-card-num">01</div>
      <div class="arch-card-title">Portfolio</div>
      <div><span class="arch-card-tag tag-stateful">Stateful</span></div>
      <p>The central ledger. Holds all state: lots, cash, trade history, realized gains, and taxes paid. Every other component reads from or writes to this object.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">02</div>
      <div class="arch-card-title">Tax Engine</div>
      <div><span class="arch-card-tag tag-stateless">Stateless</span></div>
      <p>A pure calculator. Given a gain amount and a holding period, returns the correct tax rate and amount owed. Has no memory between calls.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">03</div>
      <div class="arch-card-title">Transaction Cost Engine</div>
      <div><span class="arch-card-tag tag-stateless">Stateless</span></div>
      <p>Another pure calculator. Given an action and a base price, returns execution price after slippage and all-in cash impact including commission.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">04</div>
      <div class="arch-card-title">Daily Valuation Engine</div>
      <div><span class="arch-card-tag tag-orchestrator">Orchestrator</span></div>
      <p>The outer loop. Iterates through every trading day, processes dividends, executes scheduled trades, and records the daily NAV snapshot.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">05</div>
      <div class="arch-card-title">Portfolio Reporter</div>
      <div><span class="arch-card-tag tag-stateless">Read-Only</span></div>
      <p>Takes the final Portfolio state and produces returns, tax summaries, gain breakdowns, turnover statistics, and a visualization dashboard.</p>
    </div>
  </div>

  <div style="margin-top: 3.5rem;">
    <div class="section-label" style="margin-bottom: 1rem;">How Cash Moves</div>
    <table class="flow-table reveal">
      <tr><td>BUY</td><td>Cash out</td><td>−(shares × exec_price) − commission</td></tr>
      <tr><td>SELL</td><td>Cash in</td><td>+(shares × exec_price) − commission</td></tr>
      <tr><td>DIVIDEND</td><td>Cash in → tax out</td><td>+gross_div, then −(gross_div × dividend_rate)</td></tr>
      <tr><td>DRIP</td><td>Cash out</td><td>−(drip_shares × drip_price) − commission</td></tr>
      <tr><td>CAPITAL GAINS</td><td>Tax out</td><td>−(realized_gain × applicable_rate)</td></tr>
    </table>
  </div>
</section>

<!-- SECTION 2: TAX ENGINE -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">02 — Tax Engine</div><div class="sep-line"></div></div>
<section class="section" id="tax">
  <div class="section-label">Tax Treatment</div>
  <h2 class="section-title">Three categories.<br>One moment of truth.</h2>
  <p class="section-intro">Taxes are deducted from cash the exact moment a gain is realized — not at year-end, not as a return adjustment. This keeps portfolio value accurate every day, because timing of tax payments affects reinvestable cash.</p>

  <div class="tax-grid reveal">
    <div class="tax-card st">
      <div class="tax-rate">35%</div>
      <div class="tax-name">Short-Term Capital Gains</div>
      <div class="tax-desc">Triggered when selling shares held for <strong>fewer than 365 days</strong>. Taxed at ordinary income rates. Frequent trading or early exits land here.</div>
    </div>
    <div class="tax-card lt">
      <div class="tax-rate">20%</div>
      <div class="tax-name">Long-Term Capital Gains</div>
      <div class="tax-desc">Triggered when selling shares held for <strong>365 days or more</strong>. Preferential rate. Holding one extra day past the threshold can change your tax bill materially.</div>
    </div>
    <div class="tax-card div">
      <div class="tax-rate">15%</div>
      <div class="tax-name">Dividend Income</div>
      <div class="tax-desc">Triggered on <strong>PAYDATE</strong> only. Applied to gross dividend before reinvestment. The after-tax amount is what gets reinvested via a DRIP trade.</div>
    </div>
  </div>

  <div class="two-col reveal">
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Holding Period Classification</div>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.25rem; line-height: 1.7;">Every lot carries an <code>open_date</code>. When the lot is sold, the engine computes holding days and routes the gain to the correct tax tier.</p>
      <div class="code-block">
<span class="cm"># Classification logic in TaxEngine</span>
holding_days = (sale_date - open_date).days

<span class="kw">if</span> holding_days >= <span class="str">365</span>:
    gain_type = <span class="str">'LT'</span>  <span class="cm"># 20% rate</span>
<span class="kw">else</span>:
    gain_type = <span class="str">'ST'</span>  <span class="cm"># 35% rate</span>

<span class="cm"># Happens at LOT level — same sell order
# can trigger both ST and LT events</span>
      </div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Losses — Conservative Default</div>
      <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.25rem; line-height: 1.7;">The engine does not generate tax refunds for losing positions. A loss is recorded in the Realized Gains Ledger with a negative <code>gain_loss</code> value and <code>tax_owed = 0</code>.</p>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon">→</div>
          <div>
            <div class="principle-title">Loss reduces reported realized gain</div>
            <div class="principle-body">Visible in the Realized Gains Ledger and gains summary report.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">→</div>
          <div>
            <div class="principle-title">No positive cash event on a loss</div>
            <div class="principle-body">Extend <code>TaxEngine.compute_sale_tax</code> for loss carry-forward logic if needed.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- SECTION 3: SELL HANDLING -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">03 — Sell Handling</div><div class="sep-line"></div></div>
<section class="section" id="fifo">
  <div class="section-label">Lot Selection & Tax-Aware Selling</div>
  <h2 class="section-title">Which shares you sell matters<br>as much as when you sell.</h2>
  <p class="section-intro">When you hold multiple lots of the same stock at different cost bases, you get to choose which ones to sell. That choice directly changes your tax bill. The engine supports three strategies — set per sell order via <code>lot_selection</code>.</p>

  <!-- THREE MODE CARDS -->
  <div class="tax-grid reveal" style="margin-bottom: 3rem;">
    <div class="tax-card" style="border-top: 2px solid var(--accent2);">
      <div class="tax-rate" style="font-size: 1.4rem; color: var(--accent2); margin-bottom: 0.5rem;">FIFO</div>
      <div class="tax-name">First In, First Out</div>
      <div class="tax-desc">Always sells the <strong>oldest lot first</strong>. Simple and predictable. Oldest lots are most likely to be long-term (20% rate), so FIFO tends to favour lower tax rates — but it ignores loss opportunities.</div>
    </div>
    <div class="tax-card" style="border-top: 2px solid var(--text-muted);">
      <div class="tax-rate" style="font-size: 1.4rem; color: var(--text-muted); margin-bottom: 0.5rem;">LIFO</div>
      <div class="tax-name">Last In, First Out</div>
      <div class="tax-desc">Always sells the <strong>newest lot first</strong>. Keeps old low-basis lots alive longer, deferring their eventual gain further into the future. Useful for long holds where you want to preserve LT lots.</div>
    </div>
    <div class="tax-card lt" style="">
      <div class="tax-rate" style="font-size: 1.1rem; margin-bottom: 0.5rem;">TAX_OPTIMAL</div>
      <div class="tax-name">Tax-Loss Harvesting</div>
      <div class="tax-desc">Sells <strong>loss lots first</strong> (biggest ST loss first, then LT losses), then smallest-gain lots last. Crystallises losses into a carry-forward that offsets future gains before tax is computed.</div>
    </div>
  </div>

  <!-- THE KEY SCENARIO -->
  <div class="section-label" style="margin-bottom: 1rem;">The Scenario That Motivated This</div>
  <div class="fifo-demo reveal" style="margin-bottom: 3rem;">
    <div class="fifo-title">You hold two lots. Current price is $150. Which do you sell?</div>
    <div class="fifo-lots">
      <div class="fifo-lot sold" style="grid-template-columns: 70px 1fr auto auto auto;">
        <div class="lot-id">LOT001</div>
        <div class="lot-date">2 years ago · cost $100</div>
        <div class="lot-shares">+$50 gain / share</div>
        <div class="lot-tag tag-lt">LT</div>
        <div style="font-size:0.72rem; color: var(--accent); font-family: 'DM Mono', monospace;">tax = $10/sh</div>
      </div>
      <div class="fifo-lot partial" style="grid-template-columns: 70px 1fr auto auto auto;">
        <div class="lot-id">LOT002</div>
        <div class="lot-date">6 months ago · cost $200</div>
        <div class="lot-shares">−$50 loss / share</div>
        <div class="lot-tag tag-st">ST</div>
        <div style="font-size:0.72rem; color: var(--accent3); font-family: 'DM Mono', monospace;">tax = $0/sh</div>
      </div>
    </div>
    <div style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.8; border-top: 1px solid var(--border); padding-top: 1rem;">
      <strong style="color: var(--heading);">FIFO sells LOT001</strong> — realises a $50 LT gain, pays $10/share in tax. You keep the loss lot, but you've paid tax now.<br>
      <strong style="color: var(--accent);">TAX_OPTIMAL sells LOT002</strong> — realises a $50 ST loss, pays $0 tax, and banks that $50 loss as a <em>carry-forward</em> that will reduce tax on the next gain you realise. You keep the low-basis LT lot for later.
    </div>
  </div>

  <!-- LOSS CARRY-FORWARD -->
  <div class="two-col reveal" style="margin-bottom: 3rem;">
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Loss Carry-Forward</div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.25rem; line-height: 1.7;">Harvested losses don't disappear — they go into a carry-forward bucket (separate ST and LT balances) that automatically offsets the next gain before tax is computed.</p>
      <div class="code-block">
<span class="cm"># When a loss is realised:</span>
st_loss_carryforward += abs(loss)  <span class="cm"># or lt_</span>

<span class="cm"># When the next gain arrives:</span>
taxable = gain - st_loss_carryforward
<span class="cm"># carryforward is consumed, remainder taxed
# ST losses offset ST gains first (35% rate)
# then spill into LT gains (20% rate)</span>
      </div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Netting Priority</div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.25rem; line-height: 1.7;">The netting order is designed to maximize tax savings — losses are applied where they reduce the most tax first.</p>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon" style="color: var(--accent3); background: rgba(255,140,97,0.1); border-color: rgba(255,140,97,0.3);">ST</div>
          <div>
            <div class="principle-title">ST losses → ST gains first</div>
            <div class="principle-body">Offsets gains taxed at 35% — highest value use. Excess spills into LT gains.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon" style="color: var(--accent); background: rgba(79,255,176,0.1); border-color: rgba(79,255,176,0.3);">LT</div>
          <div>
            <div class="principle-title">LT losses → LT gains first</div>
            <div class="principle-body">Offsets gains taxed at 20%. Excess spills into ST gains.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">∞</div>
          <div>
            <div class="principle-title">Carry-forward persists</div>
            <div class="principle-body">Unused losses accumulate across the full simulation. Inspect anytime via <code>pf.tax_eng.st_loss_carryforward</code>.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- COST BASIS FORMULAS -->
  <div class="section-label" style="margin-bottom: 1rem;">Cost Basis & Realized Gain Formulas</div>
  <div class="two-col reveal">
    <div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1rem; line-height: 1.7;">Cost basis is the all-in acquisition cost — not just the closing price:</p>
      <div class="code-block">
exec_price = close_price * (<span class="str">1</span> + slippage_bps / <span class="str">10000</span>)
commission  = shares * commission_per_share

cost_basis = (shares * exec_price + commission) / shares
<span class="cm"># cost_basis > close_price — reduces overstated gains</span>
      </div>
    </div>
    <div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1rem; line-height: 1.7;">On sale, proceeds are also net of costs:</p>
      <div class="code-block">
sell_exec    = close_price * (<span class="str">1</span> - slippage_bps / <span class="str">10000</span>)
net_proceeds = shares * sell_exec - commission

gain = net_proceeds - (shares * cost_basis)
tax  = <span class="fn">compute_sale_tax</span>(gain, gain_type)
<span class="cm"># loss? → added to carry-forward, tax = 0</span>
      </div>
    </div>
  </div>
</section>

<!-- SECTION 4: WORKED EXAMPLE -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">04 — Worked Example</div><div class="sep-line"></div></div>
<section class="section">
  <div class="section-label">End-to-End Numbers</div>
  <h2 class="section-title">From purchase to after-tax<br>cash in hand.</h2>
  <p class="section-intro">A complete trace of a single lot — buy, hold, sell — showing exactly how slippage, commission, holding period, and tax rate combine to produce the final after-tax result.</p>

  <div class="example-box reveal">
    <div class="example-header">
      <div class="example-col">
        <div class="example-col-label">Purchase — Jan 3, 2022</div>
        <div class="example-line"><span class="label">Base price</span><span class="value">$150.00</span></div>
        <div class="example-line"><span class="label">Slippage (5 bps)</span><span class="value">+$0.075</span></div>
        <div class="example-line"><span class="label">Exec price</span><span class="value">$150.075</span></div>
        <div class="example-line"><span class="label">Shares</span><span class="value">500</span></div>
        <div class="example-line"><span class="label">Commission</span><span class="value">$2.50</span></div>
        <div class="example-line"><span class="label">Cost basis / share</span><span class="value pos">$150.080</span></div>
        <div class="example-line"><span class="label">Cash impact</span><span class="value neg">−$75,040.00</span></div>
      </div>
      <div class="example-col">
        <div class="example-col-label">Sale — Mar 3, 2023 (424 days later)</div>
        <div class="example-line"><span class="label">Base price</span><span class="value">$180.00</span></div>
        <div class="example-line"><span class="label">Slippage (5 bps)</span><span class="value">−$0.09</span></div>
        <div class="example-line"><span class="label">Exec price</span><span class="value">$179.91</span></div>
        <div class="example-line"><span class="label">Shares sold</span><span class="value">300</span></div>
        <div class="example-line"><span class="label">Commission</span><span class="value">$1.50</span></div>
        <div class="example-line"><span class="label">Net proceeds</span><span class="value pos">$53,971.50</span></div>
        <div class="example-line"><span class="label">Cost of 300 shares</span><span class="value neg">−$45,024.00</span></div>
      </div>
    </div>
    <div class="example-result">
      <div class="result-item">
        <div class="result-label">Realized Gain</div>
        <div class="result-value accent">$8,947.50</div>
      </div>
      <div class="result-item">
        <div class="result-label">Tax (LT · 20%)</div>
        <div class="result-value warn">$1,789.50</div>
      </div>
      <div class="result-item">
        <div class="result-label">Net Cash from Sale</div>
        <div class="result-value">$52,182.00</div>
      </div>
    </div>
  </div>
</section>

<!-- SECTION 5: DIVIDENDS -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">05 — Dividend Handling</div><div class="sep-line"></div></div>
<section class="section" id="dividends">
  <div class="section-label">DRIP Sequence</div>
  <h2 class="section-title">Dividends trigger on PAYDATE.<br>Not before. Not differently.</h2>
  <p class="section-intro">Three mistakes plague most dividend models: reinvesting on ex-date, injecting dividends into the return stream, and adjusting prices. This engine avoids all three. Dividends are cash events that create new trades — nothing else.</p>

  <div class="two-col reveal">
    <div class="steps">
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-body">
          <div class="step-title">Count shares held</div>
          <div class="step-detail">Sum open lot shares for this security as of PAYDATE. This is the entitled count.</div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-body">
          <div class="step-title">Compute gross dividend</div>
          <div class="step-detail">shares_held × DIVAMOUNT</div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-body">
          <div class="step-title">Apply dividend tax</div>
          <div class="step-detail">tax = gross_div × 0.15<br>after_tax = gross_div − tax</div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">4</div>
        <div class="step-body">
          <div class="step-title">Log realization event</div>
          <div class="step-detail">Written to Realized Gains Ledger as a DIVIDEND event with full detail.</div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">5</div>
        <div class="step-body">
          <div class="step-title">Deduct tax from cash</div>
          <div class="step-detail">+gross_div added to cash, then −tax deducted. Net: +after_tax_div in cash.</div>
        </div>
      </div>
      <div class="step">
        <div class="step-num">6</div>
        <div class="step-body">
          <div class="step-title">Execute DRIP buy</div>
          <div class="step-detail">drip_shares = after_tax_div ÷ reinvest_price<br>Goes through full Transaction Cost Engine. <strong>Creates a new lot</strong> with today as open_date.</div>
        </div>
      </div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Why DRIP Creates a New Lot</div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.5rem; line-height: 1.7;">The reinvestment does not add shares to an existing lot. It opens a brand new one — with today's price as cost basis and today as the open date.</p>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon">→</div>
          <div>
            <div class="principle-title">Different cost basis</div>
            <div class="principle-body">DRIP shares cost today's price, not the original purchase price. Gains are computed correctly when sold.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">→</div>
          <div>
            <div class="principle-title">Different holding period clock</div>
            <div class="principle-body">The 365-day LT threshold starts from the DRIP date, independent of the original position.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon">→</div>
          <div>
            <div class="principle-title">Quarterly dividends spawn many lots</div>
            <div class="principle-body">Over a multi-year hold, a single original buy can produce 8–12 DRIP lots. Each tracked separately.</div>
          </div>
        </div>
      </div>
      <div style="margin-top: 1.5rem;" class="code-block">
<span class="cm"># Missing price on pay date?
# Falls back to last available close.</span>
subset = prices[prices[<span class="str">'PRICEDATE'</span>] &lt;= pay_date]
reinvest_price = subset.<span class="fn">groupby</span>(<span class="str">'TRADINGITEMID'</span>)[
    <span class="str">'PRICECLOSE'</span>].<span class="fn">last</span>()
      </div>
    </div>
  </div>
</section>

<!-- SECTION 6: VALUATION LOOP -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">06 — Daily Valuation</div><div class="sep-line"></div></div>
<section class="section" id="valuation">
  <div class="section-label">The Daily Loop</div>
  <h2 class="section-title">Four steps. Every business day.<br>No look-ahead, ever.</h2>
  <p class="section-intro">The Daily Valuation Engine iterates through every business day using <code>pd.bdate_range</code>. Each day executes in a fixed sequence — the order matters because DRIP shares must be visible in the same day's valuation.</p>

  <div class="two-col reveal" style="margin-bottom: 3rem;">
    <div>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">01</div>
          <div>
            <div class="principle-title">Build price lookup</div>
            <div class="principle-body">Filter prices to <code>PRICEDATE ≤ today</code>, take last per security. Future prices are invisible.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">02</div>
          <div>
            <div class="principle-title">Process dividends</div>
            <div class="principle-body">Check for <code>PAYDATE == today</code>. Execute the full 6-step DRIP sequence for each match.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">03</div>
          <div>
            <div class="principle-title">Execute scheduled trades</div>
            <div class="principle-body">Check the user-provided trade schedule for orders dated today. Buys and sells routed through the full accounting pipeline.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">04</div>
          <div>
            <div class="principle-title">Record NAV snapshot</div>
            <div class="principle-body">Compute market value + cash, unrealized gain, realized YTD, taxes YTD, and daily return.</div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="formula-visual">
        <div class="big">
          <em>Portfolio Value</em><br>
          = <span>(Shares × Price)</span> + Cash
        </div>
        <div style="font-size: 0.78rem; color: var(--text-muted); margin-bottom: 0.5rem;">Recomputed from first principles every day. Never carries forward yesterday's value.</div>
        <div class="formula-breakdown">
          <div class="formula-part">
            <div class="part-key">SHARES</div>
            <div class="part-val">Sum of all open lot share counts for each security</div>
          </div>
          <div class="formula-part">
            <div class="part-key">PRICE</div>
            <div class="part-val">Last available close on or before today's date</div>
          </div>
          <div class="formula-part">
            <div class="part-key">CASH</div>
            <div class="part-val">Reflects every buy, sell, dividend, and tax event to date</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 1.5rem; padding: 1.25rem 1.5rem; background: var(--surface); border: 1px solid rgba(79,255,176,0.2); border-radius: 6px;">
        <div class="section-label" style="margin-bottom: 0.5rem;">Daily Return Is Already After-Tax</div>
        <p style="font-size: 0.84rem; color: var(--text-muted); line-height: 1.65;">Because taxes hit cash at the moment of realization, portfolio value on Day N already reflects that reduction. No separate after-tax adjustment needed. The NAV time series <em>is</em> the after-tax time series.</p>
      </div>
    </div>
  </div>

  <div class="section-label" style="margin-bottom: 1rem;">Edge Cases & Guardrails</div>
  <div class="guardrails reveal">
    <div class="guardrail">
      <div class="guardrail-trigger">Sell > shares held</div>
      <div class="guardrail-response">Order <strong>clamped to available shares</strong>. Warning emitted. No crash.</div>
    </div>
    <div class="guardrail">
      <div class="guardrail-trigger">Insufficient cash for buy</div>
      <div class="guardrail-response">Trade <strong>skipped with warning</strong>. Cash cannot go negative.</div>
    </div>
    <div class="guardrail">
      <div class="guardrail-trigger">Transaction costs exceed proceeds</div>
      <div class="guardrail-response">Sell <strong>aborted with warning</strong>. No negative cash event created.</div>
    </div>
    <div class="guardrail">
      <div class="guardrail-trigger">No price on dividend pay date</div>
      <div class="guardrail-response">Uses <strong>last available close</strong>. Weekend/holiday paydates handled automatically.</div>
    </div>
    <div class="guardrail">
      <div class="guardrail-trigger">Zero shares at dividend time</div>
      <div class="guardrail-response">Dividend <strong>silently skipped</strong>. Position was already sold.</div>
    </div>
    <div class="guardrail">
      <div class="guardrail-trigger">Sell entire position</div>
      <div class="guardrail-response">Pass <code>shares=1e9</code>. <strong>Disposal loop exhausts all lots</strong> and stops naturally regardless of mode.</div>
    </div>
  </div>
</section>

<!-- SECTION 7: REPORTING -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">07 — Reporting</div><div class="sep-line"></div></div>
<section class="section" id="reporting">
  <div class="section-label">Outputs</div>
  <h2 class="section-title">Five views of the truth.<br>All traceable to the ledger.</h2>
  <p class="section-intro">The Portfolio Reporter is read-only — it never modifies state. Every number it reports can be reproduced by querying the underlying ledgers directly.</p>

  <div class="outputs-list reveal">
    <div class="output-item">
      <div class="output-name">NAV Summary</div>
      <div class="output-desc">Full daily time series with portfolio value, cash, market value, daily return, and cumulative return. The primary output — one row per trading day for the full simulation window.</div>
    </div>
    <div class="output-item">
      <div class="output-name">After-Tax Return</div>
      <div class="output-desc">A single percentage: <code>(final_value ÷ initial_value) − 1</code>. Already net of all taxes and costs — no adjustment needed because the NAV series already reflects every tax deduction.</div>
    </div>
    <div class="output-item">
      <div class="output-name">Tax Summary</div>
      <div class="output-desc">Total taxes paid broken down by category: short-term capital gains, long-term capital gains, and dividend tax. Shows the tax efficiency cost of the strategy.</div>
    </div>
    <div class="output-item">
      <div class="output-name">Gains Summary</div>
      <div class="output-desc">Four lines: total realized gain/loss, current unrealized gain, total taxes paid, and net after-tax realized gain. The clearest view of whether the portfolio created real value.</div>
    </div>
    <div class="output-item">
      <div class="output-name">Turnover Stats</div>
      <div class="output-desc">Buy count, sell count, DRIP count, total buy and sell volumes, and total commissions paid. High turnover is expensive — both in transaction costs and in short-term tax treatment.</div>
    </div>
  </div>
</section>

<!-- SECTION 8: CONFIG -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">08 — Configuration</div><div class="sep-line"></div></div>
<section class="section" id="config">
  <div class="section-label">Two Dictionaries</div>
  <h2 class="section-title">All levers in one place.<br>Change once, flows everywhere.</h2>
  <p class="section-intro">Every configurable parameter lives at the top of the notebook. There is no hunting through class constructors or method signatures.</p>

  <div class="config-grid reveal">
    <div class="config-block">
      <div class="config-block-header">TAX_CONFIG</div>
      <div class="config-row">
        <div class="config-key">short_term_rate</div>
        <div class="config-default">0.35</div>
        <div class="config-effect">Tax rate on gains from positions held &lt; 365 days</div>
      </div>
      <div class="config-row">
        <div class="config-key">long_term_rate</div>
        <div class="config-default">0.20</div>
        <div class="config-effect">Tax rate on gains from positions held ≥ 365 days</div>
      </div>
      <div class="config-row">
        <div class="config-key">dividend_rate</div>
        <div class="config-default">0.15</div>
        <div class="config-effect">Tax rate applied to gross dividend before reinvestment</div>
      </div>
      <div class="config-row">
        <div class="config-key">lt_holding_days</div>
        <div class="config-default">365</div>
        <div class="config-effect">Days threshold between ST and LT treatment</div>
      </div>
    </div>
    <div class="config-block">
      <div class="config-block-header">COST_CONFIG</div>
      <div class="config-row">
        <div class="config-key">commission_per_share</div>
        <div class="config-default">$0.005</div>
        <div class="config-effect">Flat dollar fee per share, applied to every trade</div>
      </div>
      <div class="config-row">
        <div class="config-key">slippage_bps</div>
        <div class="config-default">5 bps</div>
        <div class="config-effect">Adverse price movement at execution. Buys pay more, sells receive less.</div>
      </div>
    </div>
  </div>

  <div style="margin-top: 2.5rem;" class="reveal">
    <div class="section-label" style="margin-bottom: 1rem;">Common Configurations</div>
    <div class="guardrails">
      <div class="guardrail">
        <div class="guardrail-trigger">Tax-deferred account (IRA / 401k)</div>
        <div class="guardrail-response">Set <code>short_term_rate</code>, <code>long_term_rate</code>, and <code>dividend_rate</code> all to <strong>0</strong>.</div>
      </div>
      <div class="guardrail">
        <div class="guardrail-trigger">Commission-free brokerage</div>
        <div class="guardrail-response">Set <code>commission_per_share</code> to <strong>0</strong>. Keep slippage.</div>
      </div>
      <div class="guardrail">
        <div class="guardrail-trigger">Everything long-term</div>
        <div class="guardrail-response">Set <code>lt_holding_days</code> to <strong>0</strong>. All gains taxed at 20%.</div>
      </div>
      <div class="guardrail">
        <div class="guardrail-trigger">Institutional slippage</div>
        <div class="guardrail-response">Increase <code>slippage_bps</code> to <strong>10–20</strong> for large-order realism.</div>
      </div>
    </div>
  </div>
</section>

<!-- SECTION 9: TRADE ALLOCATION -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">09 — Trade Allocation</div><div class="sep-line"></div></div>
<section class="section" id="allocation">
  <div class="section-label">Dollar Amounts & Weights</div>
  <h2 class="section-title">Buy $60,000 of one stock<br>and $40,000 of another.</h2>
  <p class="section-intro">Every trade row now accepts either <code>shares</code> or <code>cash_amount</code>. Set whichever you want and leave the other as <code>NaN</code>. The engine converts dollars to fractional shares at execution time using the slippage-adjusted price — so your dollar amount is exact.</p>

  <div class="two-col reveal" style="margin-bottom: 3rem;">
    <div>
      <div class="section-label" style="margin-bottom: 1rem;">Two ways to specify a trade</div>
      <div class="principles">
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">SH</div>
          <div>
            <div class="principle-title">By shares (original)</div>
            <div class="principle-body">Set <code>shares=500</code>, leave <code>cash_amount=NaN</code>. Buys exactly 500 shares at market close with slippage applied.</div>
          </div>
        </div>
        <div class="principle">
          <div class="principle-icon" style="font-size: 0.65rem; font-weight: 500;">$</div>
          <div>
            <div class="principle-title">By dollar amount</div>
            <div class="principle-body">Set <code>cash_amount=60000</code>, leave <code>shares=NaN</code>. Engine computes <code>shares = $60,000 ÷ exec_price</code> on the trade date. Fractional shares always used.</div>
          </div>
        </div>
      </div>

      <div style="margin-top: 1.5rem;">
        <div class="section-label" style="margin-bottom: 0.75rem;">How shares are computed from cash</div>
        <div class="code-block">
<span class="cm"># Slippage applied before dividing —</span>
<span class="cm"># so your cash_amount is deployed exactly</span>
<span class="kw">if</span> action == <span class="str">'BUY'</span>:
    exec_price = close * (<span class="str">1</span> + slippage_bps / <span class="str">10000</span>)
<span class="kw">else</span>:
    exec_price = close * (<span class="str">1</span> - slippage_bps / <span class="str">10000</span>)

shares = cash_amount / exec_price  <span class="cm"># fractional</span>
        </div>
      </div>
    </div>

    <div>
      <div class="section-label" style="margin-bottom: 1rem;"><code>build_weight_trades()</code> helper</div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.25rem; line-height: 1.7;">Pass a <code>{tradingitemid: weight}</code> dict and a total dollar amount. Returns a ready-to-use DataFrame of BUY rows. Weights are auto-normalised so integers work too.</p>
      <div class="code-block">
<span class="cm"># 60/40 split of $100,000</span>
trades = <span class="fn">build_weight_trades</span>(
    trade_date = <span class="str">'2020-01-02'</span>,
    weights    = {<span class="str">111</span>: <span class="str">0.60</span>, <span class="str">222</span>: <span class="str">0.40</span>},
    total_cash = <span class="str">100_000</span>,
)
<span class="cm"># → two BUY rows:
#   tid 111: cash_amount = $60,000
#   tid 222: cash_amount = $40,000</span>

<span class="cm"># Mix with other trades using pd.concat</span>
scheduled_trades = pd.concat([
    trades,
    rebalance_trades,
    sell_trades,
], ignore_index=<span class="str">True</span>)
      </div>
    </div>
  </div>

  <div class="section-label" style="margin-bottom: 1rem;">Full scheduled_trades column reference</div>
  <div class="example-box reveal">
    <table class="flow-table" style="width:100%">
      <tr>
        <td>trade_date</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;">Business day to execute. Must exist in your price history.</td>
      </tr>
      <tr>
        <td>tradingitemid</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;">Integer security ID from your prices DataFrame.</td>
      </tr>
      <tr>
        <td>action</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;"><code>'BUY'</code> or <code>'SELL'</code></td>
      </tr>
      <tr>
        <td>shares</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;">Exact share count. Set to <code>NaN</code> if using cash_amount.</td>
      </tr>
      <tr>
        <td>cash_amount</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;">Dollar amount to deploy. Converted to fractional shares at exec price. Set to <code>NaN</code> if using shares.</td>
      </tr>
      <tr>
        <td>price_override</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;">Fixed execution price. <code>NaN</code> = use market close with slippage.</td>
      </tr>
      <tr>
        <td>lot_selection</td>
        <td style="color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-size: 0.85rem;"><code>'FIFO'</code> (default) | <code>'LIFO'</code> | <code>'TAX_OPTIMAL'</code> — sells only, ignored on buys.</td>
      </tr>
    </table>
  </div>
</section>

<!-- SECTION 10: PERFORMANCE -->
<div class="sep"><div class="sep-line"></div><div class="sep-label">10 — Performance</div><div class="sep-line"></div></div>
<section class="section" id="performance">
  <div class="section-label">Optimizations</div>
  <h2 class="section-title">Built for large price files<br>and long simulations.</h2>
  <p class="section-intro">Four targeted fixes eliminate the bottlenecks that make the engine slow at scale — particularly with a large prices CSV, 20–50 securities, and a 10+ year simulation window.</p>

  <div class="arch-grid reveal" style="margin-bottom: 3rem;">
    <div class="arch-card">
      <div class="arch-card-num">01</div>
      <div class="arch-card-title">Security Filter</div>
      <div><span class="arch-card-tag tag-stateless">Data Loading</span></div>
      <p>Set <code>TRADING_IDS</code> to only the securities you trade. The loader drops all other rows from the prices CSV before anything else runs. A 3M-row file covering 5,000 stocks cut to 50 securities drops to ~30,000 rows — <strong>99% smaller</strong>.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">02</div>
      <div class="arch-card-title">Pre-Built Price Table</div>
      <div><span class="arch-card-tag tag-orchestrator">Daily Loop</span></div>
      <p>The old <code>_last_price_lookup</code> ran a full filter + sort + groupby on every trading day. Now replaced with a forward-filled pivot table built once in <code>__init__</code>. Each day's lookup is a single <strong>O(1) <code>.loc[]</code> row access</strong>. Over 2,500 days that's 2,500 expensive operations → 2,500 dict lookups.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">03</div>
      <div class="arch-card-title">List-Based Ledger Buffers</div>
      <div><span class="arch-card-tag tag-stateful">Portfolio</span></div>
      <p>Six ledgers (lots, trades, realized, taxes, dividends, nav) previously used <code>pd.concat</code> row-by-row — copying the entire DataFrame on every append. Now accumulates rows as plain dicts in a list, materializes to DataFrame once. Eliminates the <strong>O(n²) memory pattern</strong>.</p>
    </div>
    <div class="arch-card">
      <div class="arch-card-num">04</div>
      <div class="arch-card-title">Lot Index + Reverse Map</div>
      <div><span class="arch-card-tag tag-stateful">Portfolio</span></div>
      <p><code>_open_lots_for</code> previously scanned the full lots DataFrame on every sell and dividend. Now uses <code>_lots_idx</code> (security → list of lot positions) for O(k) lookup, and <code>_lot_id_to_buf</code> for O(1) sell updates. Critical for 50 securities with quarterly dividends over 10 years.</p>
    </div>
  </div>

  <div class="section-label" style="margin-bottom: 1rem;">Setting up TRADING_IDS</div>
  <div class="two-col reveal">
    <div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.25rem; line-height: 1.7;">This is the single most impactful setting. Put it in the data loading cell before anything else runs.</p>
      <div class="code-block">
<span class="cm"># Set to the IDs you are actually trading</span>
TRADING_IDS = [<span class="str">12345</span>, <span class="str">67890</span>, <span class="str">11111</span>]

<span class="cm"># Set to None to load ALL securities (slow)</span>
TRADING_IDS = <span class="str">None</span>

<span class="cm"># Also trim the date window for further gains</span>
SIM_START = pd.Timestamp(<span class="str">'2015-01-01'</span>)
SIM_END   = pd.Timestamp(<span class="str">'2024-12-31'</span>)
      </div>
    </div>
    <div>
      <div class="section-label" style="margin-bottom: 0.75rem;">How the pivot table works</div>
      <p style="color: var(--text-muted); font-size: 0.88rem; margin-bottom: 1.25rem; line-height: 1.7;">Built once in <code>DailyValuationEngine.__init__</code>. Rows = every calendar date, columns = TRADINGITEMIDs. Forward-fill propagates Friday's close into weekends — no special-casing needed for holidays or dividend pay dates.</p>
      <div class="code-block">
<span class="cm"># Built once at engine startup</span>
pivot = prices.<span class="fn">pivot_table</span>(
    index=<span class="str">'PRICEDATE'</span>,
    columns=<span class="str">'TRADINGITEMID'</span>,
    values=<span class="str">'PRICECLOSE'</span>,
    aggfunc=<span class="str">'last'</span>,
)
price_table = pivot.<span class="fn">reindex</span>(full_date_range).<span class="fn">ffill</span>()

<span class="cm"># Each day in the loop — O(1)</span>
lookup = price_table.<span class="fn">loc</span>[today].<span class="fn">dropna</span>().<span class="fn">to_dict</span>()
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<hr class="divider">
<footer>
  <div class="footer-brand">PORTFOLIO ACCOUNTING ENGINE</div>
  <div class="footer-note">Transaction-driven · Tax-aware selling · Dollar & weight allocation · Optimized for scale</div>
</footer>

<script>
  // Scroll reveal
  const reveals = document.querySelectorAll('.reveal');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry, i) => {
      if (entry.isIntersecting) {
        setTimeout(() => entry.target.classList.add('visible'), i * 60);
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.08 });
  reveals.forEach(el => observer.observe(el));

  // Active nav link
  const sections = document.querySelectorAll('section[id]');
  const navLinks = document.querySelectorAll('.nav-links a');
  window.addEventListener('scroll', () => {
    let current = '';
    sections.forEach(s => {
      if (window.scrollY >= s.offsetTop - 100) current = s.id;
    });
    navLinks.forEach(a => {
      a.style.color = a.getAttribute('href') === '#' + current ? 'var(--accent)' : '';
    });
  });
</script>
</body>
</html>
